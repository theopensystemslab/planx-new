import{v as X,w as ee,j as e,u as p,ac as ae,Z as R,B as w,T as g,n as V,a6 as te,r as v,a2 as _,ad as H,a3 as Y,p as A,q as $,L as se,ae as k,a5 as F,W as I,a7 as ne,af as ie,V as oe,a8 as re,Q as le}from"./index-CFPw1vJP.js";import{P as ce}from"./PublicLayout-CsB_Cq8y.js";import{r as z,g as G,t as j,h as de,i as ue,j as B,u as U}from"./Header-p4OIyhRV.js";import{C as P,c as M}from"./Card-XAp8rL3L.js";import{B as q,S as me,F as he,c as Q,a as W,b as Z,I as N,d as pe}from"./Questions-D-dg2tg0.js";import{a as ge}from"./index-5h7nDx4c.js";function xe(t,a){z(2,arguments);var s=G(t),n=j(a);if(isNaN(n))return new Date(NaN);if(!n)return s;var i=s.getDate(),r=new Date(s.getTime());r.setMonth(s.getMonth()+n+1,0);var c=r.getDate();return i>=c?r:(s.setFullYear(r.getFullYear(),r.getMonth(),i),s)}function ve(t,a){if(z(2,arguments),!a||de(a)!=="object")return new Date(NaN);var s=a.years?j(a.years):0,n=a.months?j(a.months):0,i=a.weeks?j(a.weeks):0,r=a.days?j(a.days):0,c=a.hours?j(a.hours):0,o=a.minutes?j(a.minutes):0,l=a.seconds?j(a.seconds):0,x=G(t),u=n||s?xe(x,n+s*12):x,d=r||i?ge(u,r+i*7):u,f=o+c*60,h=l+f*60,m=h*1e3,T=new Date(d.getTime()+m);return T}var L={},fe=ee;Object.defineProperty(L,"__esModule",{value:!0});var J=L.default=void 0,ye=fe(X()),be=e,je=(0,ye.default)((0,be.jsx)("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}),"WarningOutlined");J=L.default=je;const we=({bannerHeading:t,reconciliationResponse:a,buttonText:s,onButtonClick:n})=>{const[i,r,c,o,l,x,u]=p(m=>[m.flow,m.hasSections,m.sectionNodes,m.currentCard(),m.changeAnswer,m.record,m.computePassport()]),d=()=>{n&&n(),o&&o.id&&o.type===te.ComponentType.Section&&x(o.id,{auto:!1})},f=ae(a.reconciledSessionData.breadcrumbs,i),h=R();return e.jsxs(e.Fragment,{children:[e.jsx(w,{width:"100%",children:e.jsx(q,{heading:t,color:{background:h.palette.info.light,text:h.palette.text.primary}})}),e.jsxs(P,{children:[a.changesFound&&e.jsxs(w,{display:"flex",mb:4,children:[e.jsx(J,{titleAccess:"Warning",color:"primary",fontSize:"large",sx:{p:2.5}}),e.jsx(g,{variant:"body2",sx:{pl:1},children:a.message})]}),e.jsxs(g,{variant:"h2",children:["Review your ",r?"progress":"answers"," so far"]}),r?e.jsx(me,{flow:i,alteredSectionIds:a.alteredSectionIds,changeAnswer:l,nextQuestion:d,showChange:!1,isReconciliation:!0,sectionNodes:c,currentCard:o,breadcrumbs:f}):e.jsx(ue,{breadcrumbs:f,flow:i,passport:u,changeAnswer:l,showChangeButton:!1,sectionComponent:"h3"}),s&&e.jsx(V,{variant:"contained",color:"primary",size:"large","data-testid":"continue-button",onClick:d,children:s})]})]})},C=({bannerHeading:t,bannerText:a,buttonText:s,onButtonClick:n,showDownloadLink:i,additionalOption:r,children:c})=>{const o=R(),[l,x]=v.useState([]),[u,d,f]=p(h=>[h.sessionId,h.saveToEmail,h.$public]);return v.useEffect(()=>{const h=async()=>{if(u&&d){const m=await f({session:{sessionId:u,email:d}}).export.csvData(u);x(m)}};(l==null?void 0:l.length)<1&&h()}),e.jsxs(e.Fragment,{children:[e.jsx(w,{width:"100%",children:e.jsx(q,{heading:t,color:{background:o.palette.info.light,text:o.palette.text.primary},children:a&&e.jsx(w,{mt:4,children:e.jsx(g,{children:a})})})}),e.jsxs(P,{children:[c,i&&e.jsx(he,{data:l,filename:u||"application"}),s&&e.jsx(V,{variant:"contained",color:"primary",size:"large",onClick:n,sx:{mt:4},children:s}),r==="startNewApplication"&&e.jsxs(e.Fragment,{children:[e.jsx(g,{sx:M,variant:"body1",children:"or"}),e.jsx(_,{component:"button",onClick:H,sx:M,children:e.jsx(g,{variant:"body1",align:"left",children:"Start new application"})})]})]})]})},Se=({setEmail:t})=>{const a=Q({email:W().email("Invalid email").required("Email address required")}),s=U({initialValues:{email:""},onSubmit:n=>t(n.email),validateOnChange:!1,validateOnBlur:!1,validationSchema:a});return e.jsx(w,{width:"100%",children:e.jsxs(P,{handleSubmit:s.handleSubmit,children:[e.jsx(Z,{title:"Resume your application",description:"Enter your email to resume your application."}),e.jsx(A,{children:e.jsx(N,{label:"Email address",htmlFor:"email",children:e.jsx($,{bordered:!0,errorMessage:s.touched.email&&s.errors.email?s.errors.email:void 0,id:"email",name:"email",onBlur:s.handleBlur,onChange:s.handleChange,type:"email",value:s.values.email})})})]})})},Ee=({retry:t})=>e.jsx(C,{bannerHeading:"Email not sent",buttonText:"Retry",onButtonClick:t,children:e.jsxs(g,{variant:"body1",children:["We are having trouble sending emails at the moment.",e.jsx("br",{}),e.jsx("br",{}),"We have saved your application. We will try to send the email again later."]})}),Ce=()=>e.jsx(C,{bannerHeading:"Check your email",children:e.jsxs(g,{variant:"body1",children:["If you have any draft applications we have sent you an email that contains a link. Use this link to access your applications.",e.jsx("br",{}),e.jsx("br",{}),"You may now close this tab."]})}),ke=({reconciliationResponse:t,continueApplication:a})=>e.jsx(we,{bannerHeading:"Resume your application",reconciliationResponse:t,buttonText:"Continue",onButtonClick:()=>a()}),De=({retry:t})=>e.jsxs(C,{bannerHeading:"We can't find your application",buttonText:"Try again",onButtonClick:t,additionalOption:"startNewApplication",children:[e.jsx(g,{variant:"h3",component:"h2",children:"Reasons"}),e.jsxs(g,{variant:"body1",children:[e.jsx("br",{}),"This may be because your application has expired or there was a mistake in your email address.",e.jsx("br",{}),e.jsx("br",{}),"Try entering your email address again."]})]}),Fe=({paymentRequest:t})=>e.jsx(C,{bannerHeading:"Sorry, you can't make changes to this application",additionalOption:"startNewApplication",children:e.jsxs(g,{variant:"body1",children:["This is because you've invited ",t==null?void 0:t.payeeName," (",e.jsx(_,{href:`mailto:${t==null?void 0:t.payeeEmail}`,children:t==null?void 0:t.payeeEmail}),") to pay for this application and changes might affect the fee.",e.jsx("br",{}),e.jsx("br",{}),"You can"," ",e.jsx(_,{component:se,href:`../pay?paymentRequestId=${t==null?void 0:t.id}`,children:"pay for this application yourself on the payment page"})]})}),Ie=t=>["https://www.payments.service.gov.uk/","https://card.payments.service.gov.uk/"].includes(document.referrer)&&t?t:"",Be=()=>{const t=B(),[a,s]=v.useState(0),[n,i]=v.useState(Ie(t.url.query.email)),[r,c]=v.useState(),o=B().url.query.sessionId,[l,x]=v.useState();v.useEffect(()=>{n&&O()},[n]);const u=p(y=>y.teamSlug),d=p(y=>y.resumeSession),f=()=>{p.setState({saveToEmail:n,path:k.SaveAndReturn})},h=async()=>{const y="http://localhost:7002/resume-application",S={payload:{email:n,teamSlug:u}};try{await F.post(y,S),s(4)}catch{s(5)}},m=y=>{var S,E;return((E=(S=y.govUkPayment)==null?void 0:S.state)==null?void 0:E.status)==="created"},T=async()=>{var E;const y="http://localhost:7002/validate-session",S={payload:{email:n,sessionId:o}};try{await F.post(y,S).then(b=>{if(b.data){const D=b.data.reconciledSessionData;x(b.data),d(D),m(D)?f():s(2)}})}catch(b){if(F.isAxiosError(b)&&((E=b.response)==null?void 0:E.status)===403){const D=b.response.data;c(D.paymentRequest),s(6);return}console.debug(b),s(3)}},O=()=>{s(1),o?T():h()},K=()=>{i(""),s(0)};return{0:e.jsx(Se,{setEmail:i}),1:e.jsx(Y,{text:o?"Validating...":"Sending..."}),2:e.jsx(ke,{reconciliationResponse:l,continueApplication:f}),3:e.jsx(De,{retry:K}),6:e.jsx(Fe,{paymentRequest:r}),4:e.jsx(Ce,{}),5:e.jsx(Ee,{retry:()=>O()})}[a]},Pe=Q({email:W().email("Invalid email").required("Email address required"),confirmEmail:W().email("Invalid email").required("Email address required").oneOf([pe("email"),null],"Emails must match")}),Te=({handleSubmit:t})=>{const a=U({initialValues:{email:"",confirmEmail:""},onSubmit:s=>t(s.confirmEmail),validateOnChange:!1,validateOnBlur:!1,validationSchema:Pe});return e.jsx(w,{width:"100%",children:e.jsxs(P,{handleSubmit:a.handleSubmit,children:[e.jsx(Z,{title:"Enter your email address",description:"We will use this to save your application so you can come back to it later. We will also email you updates about your application."}),e.jsx(A,{children:e.jsx(N,{label:"Email address",htmlFor:"email",children:e.jsx($,{bordered:!0,errorMessage:a.touched.email&&a.errors.email?a.errors.email:void 0,id:"email",name:"email",onBlur:a.handleBlur,onChange:a.handleChange,type:"email",value:a.values.email})})}),e.jsx(A,{children:e.jsx(N,{label:"Confirm email address",htmlFor:"confirmEmail",children:e.jsx($,{bordered:!0,errorMessage:a.touched.confirmEmail&&a.errors.confirmEmail?a.errors.confirmEmail:void 0,id:"confirmEmail",name:"confirmEmail",onBlur:a.handleBlur,onChange:a.handleChange,type:"email",value:a.values.confirmEmail})})})]})})},_e=({children:t})=>{var c,o;const a=!!p(l=>l.saveToEmail),s=p(l=>l.sessionId),n=(o=(c=B())==null?void 0:c.data)==null?void 0:o.isContentPage,i=()=>{const l=new URL(window.location.href);l.searchParams.set("sessionId",s),window.history.pushState({},document.title,l)},r=l=>{p.setState({saveToEmail:l}),i()};return e.jsx(e.Fragment,{children:a||n?t:e.jsx(Te,{handleSubmit:r})})},Ae=({saveToEmail:t,expiryDate:a})=>e.jsx(C,{bannerHeading:"Application saved",showDownloadLink:!0,buttonText:"Start a new application",onButtonClick:H,children:e.jsxs(g,{variant:"body2",children:["We have sent a link to ",t,". Use the link to continue your application.",e.jsx("br",{}),e.jsx("br",{}),"You have until ",a," to complete this application.",e.jsx("br",{}),e.jsx("br",{}),"Your application will be deleted if you do not complete it by this date.",e.jsx("br",{}),e.jsx("br",{}),"You may now close this tab."]})}),$e=()=>e.jsx(C,{bannerHeading:"Email not sent",showDownloadLink:!0,children:e.jsxs(g,{variant:"body2",children:["We are having trouble sending emails at the moment.",e.jsx("br",{}),e.jsx("br",{}),"We have saved your application. We will try to send the email again later."]})}),We=()=>{const t=p(o=>o.saveToEmail),a=ve(new Date,{days:28}).toDateString(),[s,n]=v.useState(0),[i,r]=v.useState(a),c=async()=>{var u;const o="http://localhost:7002/send-email/save",{sessionId:l}=p.getState(),x={payload:{email:t,sessionId:l}};try{const d=await F.post(o,x);n(1),r(((u=d==null?void 0:d.data)==null?void 0:u.expiryDate)||a)}catch(d){console.error(d),n(2)}};return v.useEffect(()=>{t?c():n(2)},[]),{0:e.jsx(Y,{text:"Sending..."}),1:e.jsx(Ae,{saveToEmail:t,expiryDate:i}),2:e.jsx($e,{})}[s]},Ne=({children:t})=>{const a=p(n=>n.path);if(B().error)throw new I;return e.jsx(e.Fragment,{children:{[k.SingleSession]:t,[k.Save]:e.jsx(w,{component:"main",id:"main-content",sx:{width:"100%"},children:e.jsx(We,{})}),[k.Resume]:e.jsx(w,{component:"main",id:"main-content",sx:{width:"100%"},children:e.jsx(Be,{})}),[k.SaveAndReturn]:e.jsx(_e,{children:t})}[a]})},ze=async t=>{var o;const a=t.params.flow.split(",")[0],s=t.params.team||await ne(window.location.hostname),n=await Le(a,s),i=n.flows[0];if(!i)throw new I(`Flow ${a} not found for ${s}`);const r=(o=i.publishedFlows[0])==null?void 0:o.data;if(!r)throw new I(`Flow ${a} not published for ${s}`);ie(r,t);const c=p.getState();return c.setFlow({id:i.id,flow:r,flowSlug:a}),c.setGlobalSettings(n.globalSettings[0]),c.setFlowSettings(i.settings),c.setTeam(i.team),e.jsx(ce,{children:e.jsx(Ne,{children:e.jsx(oe,{})})})},Le=async(t,a)=>{try{return(await re.query({query:le`
        query GetSettingsForPublishedView(
          $flowSlug: String!
          $teamSlug: String!
        ) {
          flows(
            limit: 1
            where: {
              slug: { _eq: $flowSlug }
              team: { slug: { _eq: $teamSlug } }
            }
          ) {
            id
            team {
              theme {
                primaryColour: primary_colour
                actionColour: action_colour
                linkColour: link_colour
                logo
                favicon
              }
              name
              settings
              integrations {
                hasPlanningData: has_planning_data
              }
              slug
              notifyPersonalisation: notify_personalisation
              boundaryBBox: boundary_bbox
            }
            settings
            publishedFlows: published_flows(
              limit: 1
              order_by: { created_at: desc }
            ) {
              data
            }
          }
          globalSettings: global_settings {
            footerContent: footer_content
          }
        }
      `,variables:{flowSlug:t,teamSlug:a}})).data}catch(s){throw console.error(s),new I}};export{Le as f,ze as p};
