name: Vultr Deploy
on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

env:
  DOMAIN: planx.club
  FULL_DOMAIN: ${{ github.event.number }}.planx.club
  VULTR_URL: https://${{ github.event.number }}.planx.club

jobs:
  create_vultr_instance:
    runs-on: ubuntu-latest
    steps:
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: vultr
          message: |
            Allocating resources for ${{ env.VULTR_URL }}

      - name: Create Server
        id: create
        uses: theopensystemslab/vultr-action@v1
        with:
          action: create
          api_key: ${{ secrets.VULTR_API_KEY }}
          domain: ${{ env.DOMAIN }}
          os_id: 387
          plan: vc2-1c-1gb
          pullrequest_id: ${{ github.event.number }}
          region: lhr
          tag: pullrequest

      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: vultr
          message: |
            Deploying ${{ github.sha }} to ${{ env.VULTR_URL }}

      - name: Create commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.FULL_DOMAIN }}
          username: root
          password: ${{ steps.create.outputs.default_password }}
          script: scripts/pullrequest/create
        env:
          PULLREQUEST_ID: ${{ github.event.number }}
          REPO_URL: ${{ secrets.AUTHENTICATED_REPO_URL }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}

  # upload-artifact:
  #   name: Upload
  #   needs: prepare-vps
  #   steps:
  #     - uses: actions/checkout@master
  #     - name: copy file via ssh password
  #       uses: appleboy/scp-action@master
  #       with:
  #         host: ${{ env.VULTR_DOMAIN }}
  #         username: ${{ secrets.USERNAME }}
  #         password: ${{ secrets.PASSWORD }}
  #         target: "artifact"

  # finish-comment:
  #   uses: marocchino/sticky-pull-request-comment@v2
  #   needs: upload-artifact
  #   with:
  #     header: vultr
  #     message: |
  #       Deployed ${{ github.sha }} to <${{ env.VULTR_DOMAIN }}>
