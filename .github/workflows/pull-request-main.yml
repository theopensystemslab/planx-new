name: Vultr Deploy
on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

env:
  DOMAIN: planx.club
  FULL_DOMAIN: ${{ github.event.number }}.planx.club
  VULTR_URL: https://${{ github.event.number }}.planx.club

jobs:
  create_vultr_instance:
    runs-on: ubuntu-latest
    steps:
      # - uses: marocchino/sticky-pull-request-comment@v2
      #   with:
      #     header: vultr
      #     message: |
      #       Allocating resources for ${{ env.VULTR_URL }}

      # - name: Create Server
      #   id: create
      #   uses: theopensystemslab/vultr-action@v1.4
      #   with:
      #     action: create
      #     api_key: ${{ secrets.VULTR_API_KEY }}
      #     domain: ${{ env.DOMAIN }}
      #     os_id: 387
      #     plan: vc2-1c-1gb
      #     pullrequest_id: ${{ github.event.number }}
      #     region: lhr
      #     tag: pullrequest

      # - uses: marocchino/sticky-pull-request-comment@v2
      #   with:
      #     header: vultr
      #     message: |
      #       Deploying ${{ github.sha }} to ${{ env.VULTR_URL }}

      - name: Create commands
        uses: appleboy/ssh-action@master
        env:
          PULLREQUEST_ID: ${{ github.event.number }}
          REPO_URL: ${{ secrets.AUTHENTICATED_REPO_URL }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        with:
          host: ${{ env.FULL_DOMAIN }}
          username: root
          password: "v_6Aqo@!2d-MJmY2"
          # https://github.com/appleboy/ssh-action#pass-environment-variable-to-shell-script
          # https://github.com/appleboy/ssh-action/issues/124
          envs: PULLREQUEST_ID,REPO_URL,SSH_PASSWORD
          script: |
            PULLREQUEST_ID="${PULLREQUEST_ID}" REPO_URL="${REPO_URL}" SSH_PASSWORD="${SSH_PASSWORD}" scripts/pullrequest/create.sh

  # upload-artifact:
  #   name: Upload
  #   needs: prepare-vps
  #   steps:
  #     - uses: actions/checkout@master
  #     - name: copy file via ssh password
  #       uses: appleboy/scp-action@master
  #       with:
  #         host: ${{ env.VULTR_DOMAIN }}
  #         username: ${{ secrets.USERNAME }}
  #         password: ${{ secrets.PASSWORD }}
  #         target: "artifact"

  # finish-comment:
  #   uses: marocchino/sticky-pull-request-comment@v2
  #   needs: upload-artifact
  #   with:
  #     header: vultr
  #     message: |
  #       Deployed ${{ github.sha }} to <${{ env.VULTR_DOMAIN }}>
