- table:
    schema: public
    name: analytics
  insert_permissions:
    - role: public
      permission:
        check: {}
        columns:
          - created_at
          - flow_id
          - id
          - type
        backend_only: false
  select_permissions:
    - role: public
      permission:
        columns:
          - id
        filter: {}
- table:
    schema: public
    name: analytics_logs
  insert_permissions:
    - role: public
      permission:
        check: {}
        columns:
          - analytics_id
          - created_at
          - flow_direction
          - has_clicked_help
          - id
          - metadata
          - node_title
          - node_type
          - user_exit
        backend_only: false
  select_permissions:
    - role: public
      permission:
        columns:
          - analytics_id
          - id
        filter: {}
  update_permissions:
    - role: public
      permission:
        columns:
          - has_clicked_help
        filter: {}
        check: null
- table:
    schema: public
    name: blpu_codes
  select_permissions:
    - role: public
      permission:
        columns:
          - description
          - code
          - value
        filter: {}
- table:
    schema: public
    name: bops_applications
- table:
    schema: public
    name: flow_schemas
  select_permissions:
    - role: public
      permission:
        columns:
          - flow_id
          - node
          - type
          - planx_variable
        filter: {}
- table:
    schema: public
    name: flows
  object_relationships:
    - name: creator
      using:
        foreign_key_constraint_on: creator_id
    - name: team
      using:
        foreign_key_constraint_on: team_id
  array_relationships:
    - name: operations
      using:
        foreign_key_constraint_on:
          column: flow_id
          table:
            schema: public
            name: operations
    - name: published_flows
      using:
        foreign_key_constraint_on:
          column: flow_id
          table:
            schema: public
            name: published_flows
    - name: session_backups
      using:
        foreign_key_constraint_on:
          column: flow_id
          table:
            schema: public
            name: session_backups
  computed_fields:
    - name: data_merged
      definition:
        function:
          schema: public
          name: compile_flow_portals
      comment: Flow data with portals merged in
  select_permissions:
    - role: public
      permission:
        columns:
          - id
          - team_id
          - slug
          - creator_id
          - data
          - version
          - created_at
          - updated_at
          - settings
        computed_fields:
          - data_merged
        filter: {}
- table:
    schema: public
    name: global_settings
  select_permissions:
    - role: public
      permission:
        columns:
          - footer_content
        filter: {}
- table:
    schema: public
    name: lowcal_sessions
  object_relationships:
    - name: flow
      using:
        manual_configuration:
          remote_table:
            schema: public
            name: flows
          insertion_order: null
          column_mapping:
            flow_id: id
  insert_permissions:
    - role: public
      permission:
        check: {}
        columns:
          - data
          - email
          - id
        backend_only: false
  select_permissions:
    - role: public
      permission:
        columns:
          - id
          - data
        filter: {}
  update_permissions:
    - role: public
      permission:
        columns:
          - data
          - email
          - id
        filter: {}
        check: null
  delete_permissions:
    - role: public
      permission:
        filter: {}
  event_triggers:
    - name: setup_lowcal_expiry_events
      definition:
        enable_manual: false
        insert:
          columns: '*'
      retry_conf:
        num_retries: 3
        interval_sec: 10
        timeout_sec: 60
      webhook: http://localhost:8080/v1/metadata
      headers:
        - name: x-hasura-admin-secret
          value_from_env: ADMIN_SECRET
      request_transform:
        body: |-
          {
              "type": "create_scheduled_event",
              "args": {
                  "webhook": "http://api:7002/send-email/expiry",
                  "schedule_at": {{$body.event.data.new.expiry_date}},
                  "payload": {
                    "sessionId": {{$body.event.data.new.id}},
                    "email": {{$body.event.data.new.email}}
                  },
                  "comment": "expiry_{{$body.event.data.new.id}}",
                  "headers": [{
                      "name":"authorization",
                      "value_from_env":"HASURA_PLANX_API_KEY"
                  }]
              }
          }
        content_type: application/json
        template_engine: Kriti
    - name: setup_lowcal_reminder_events
      definition:
        enable_manual: false
        insert:
          columns: '*'
      retry_conf:
        num_retries: 3
        interval_sec: 10
        timeout_sec: 60
      webhook: http://localhost:8080/v1/metadata
      headers:
        - name: x-hasura-admin-secret
          value_from_env: ADMIN_SECRET
      request_transform:
        body: |-
          {
              "type": "create_scheduled_event",
              "args": {
                  "webhook": "http://api:7002/send-email/reminder",
                  "schedule_at": {{$body.event.data.new.reminder_date}},
                  "payload": {
                    "sessionId": {{$body.event.data.new.id}},
                    "email": {{$body.event.data.new.email}}
                  },
                  "comment": "reminder_{{$body.event.data.new.id}}",
                  "headers": [{
                      "name":"authorization",
                      "value_from_env":"HASURA_PLANX_API_KEY"
                  }]
              }
          }
        content_type: application/json
        template_engine: Kriti
- table:
    schema: public
    name: operations
  object_relationships:
    - name: actor
      using:
        foreign_key_constraint_on: actor_id
    - name: flow
      using:
        foreign_key_constraint_on: flow_id
- table:
    schema: public
    name: planning_constraints_requests
- table:
    schema: public
    name: published_flows
  object_relationships:
    - name: flow
      using:
        foreign_key_constraint_on: flow_id
    - name: user
      using:
        foreign_key_constraint_on: publisher_id
  select_permissions:
    - role: public
      permission:
        columns:
          - created_at
          - data
          - flow_id
          - id
          - publisher_id
          - summary
        filter: {}
- table:
    schema: public
    name: session_backups
  object_relationships:
    - name: flow
      using:
        foreign_key_constraint_on: flow_id
  insert_permissions:
    - role: public
      permission:
        check: {}
        columns:
          - flow_data
          - flow_id
          - session_id
          - user_data
        backend_only: false
- table:
    schema: public
    name: team_members
  object_relationships:
    - name: creator
      using:
        foreign_key_constraint_on: creator_id
    - name: team
      using:
        foreign_key_constraint_on: team_id
    - name: user
      using:
        foreign_key_constraint_on: user_id
- table:
    schema: public
    name: teams
  array_relationships:
    - name: flows
      using:
        foreign_key_constraint_on:
          column: team_id
          table:
            schema: public
            name: flows
    - name: members
      using:
        foreign_key_constraint_on:
          column: team_id
          table:
            schema: public
            name: team_members
  select_permissions:
    - role: public
      permission:
        columns:
          - created_at
          - id
          - name
          - notifyPersonalisation
          - settings
          - slug
          - theme
          - updated_at
        filter: {}
- table:
    schema: public
    name: users
  array_relationships:
    - name: created_flows
      using:
        foreign_key_constraint_on:
          column: creator_id
          table:
            schema: public
            name: flows
    - name: created_team_members
      using:
        foreign_key_constraint_on:
          column: creator_id
          table:
            schema: public
            name: team_members
    - name: operations
      using:
        foreign_key_constraint_on:
          column: actor_id
          table:
            schema: public
            name: operations
    - name: team_members
      using:
        foreign_key_constraint_on:
          column: user_id
          table:
            schema: public
            name: team_members
