# Pizzas use [caddy-gen](https://hub.docker.com/r/wemakeservices/caddy-gen) as a reverse proxy
# the "virtual.*" labels configure mapping rules

services:
  postgres:
    volumes:
      - postgres_data:/var/lib/postgresql/data

  api:
    build:
      target: production
    volumes:
      - "/api/node_modules"
      - "/api/dist"
    environment:
      NODE_ENV: "pizza"

  editor:
    image: pierrezemb/gostatic
    volumes:
      - ./editor.planx.uk/build:/srv/http
    entrypoint: "/goStatic -fallback /index.html"

  localplanning:
    image: pierrezemb/gostatic
    volumes:
      - ./localplanning.services/dist:/srv/http
    entrypoint: "/goStatic -fallback /index.html"

  storybook:
    image: pierrezemb/gostatic
    volumes:
      - ./editor.planx.uk/build/storybook:/srv/http
    entrypoint: "/goStatic -port 8044 -fallback /index.html"

  caddy:
    build:
      context: ./ci/caddy
    restart: unless-stopped
    volumes:
      - ./ci/caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data  # certs + keys
      - caddy_config:/config  # autosaved JSON config
    ports:
      - 80:80
      - 443:443
    environment:
      - TLS_EMAIL=${TLS_EMAIL}
      - ROOT_DOMAIN=${ROOT_DOMAIN}
      - VULTR_API_KEY=${VULTR_API_KEY}
      - API_PORT=${API_PORT}
      - HASURA_PROXY_PORT=${HASURA_PROXY_PORT}
      - PG_PORT=${PG_PORT}
      - SHAREDB_PORT=${SHAREDB_PORT}

volumes:
  postgres_data:
  caddy_data:
  caddy_config:
