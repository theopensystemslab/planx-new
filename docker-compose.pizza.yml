services:
  postgres:
    volumes:
      - postgres_data:/var/lib/postgresql/data

  api:
    build:
      target: production
    volumes:
      - "/api/node_modules"
      - "/api/dist"
    environment:
      NODE_ENV: "pizza"

  editor:
    container_name: editor
    image: pierrezemb/gostatic
    volumes:
      - ./editor.planx.uk/build:/srv/http
    entrypoint: "/goStatic -fallback /index.html"

  localplanning:
    container_name: localplanning
    image: pierrezemb/gostatic
    volumes:
      - ./apps/localplanning.services/dist:/srv/http
    entrypoint: "/goStatic -fallback /404.html"

  storybook:
    container_name: storybook
    image: pierrezemb/gostatic
    volumes:
      - ./editor.planx.uk/build/storybook:/srv/http
    entrypoint: "/goStatic -port 8044 -fallback /index.html"

  caddy:
    # always pull image from private Vultr registry
    image: lhr.vultrcr.com/planx/caddy-vultr:latest
    pull_policy: always
    container_name: caddy
    restart: unless-stopped
    volumes:
      - ./ci/caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data  # certs + keys
      - caddy_config:/config  # autosaved JSON config
    ports:
      - "80:80"
      - "443:443"
      - "2019:2019"
    environment:
      - TLS_EMAIL=${TLS_EMAIL}
      - ROOT_DOMAIN=${ROOT_DOMAIN}
      - VULTR_API_KEY=${VULTR_API_KEY}
      - API_PORT=${API_PORT}
      - HASURA_PROXY_PORT=${HASURA_PROXY_PORT}
      - PG_PORT=${PG_PORT}
      - SHAREDB_PORT=${SHAREDB_PORT}

volumes:
  postgres_data:
  caddy_data:
  caddy_config:
