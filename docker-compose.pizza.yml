services:
  postgres:
    volumes:
      - postgres_data:/var/lib/postgresql/data

  api:
    build:
      target: production
    volumes:
      - "/api/node_modules"
      - "/api/dist"
    environment:
      NODE_ENV: "pizza"

  editor:
    image: pierrezemb/gostatic
    volumes:
      - ./editor.planx.uk/build:/srv/http
    entrypoint: "/goStatic -fallback /index.html"

  localplanning:
    image: pierrezemb/gostatic
    volumes:
      - ./localplanning.services/dist:/srv/http
    entrypoint: "/goStatic -fallback /index.html"

  storybook:
    image: pierrezemb/gostatic
    volumes:
      - ./editor.planx.uk/build/storybook:/srv/http
    entrypoint: "/goStatic -port 8044 -fallback /index.html"

  caddy:
    build:
      context: ./ci/caddy
    restart: always
    volumes:
      - ./ci/caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    ports:
      - 80:80
      - 443:443
    environment:
      - VULTR_API_KEY=${VULTR_API_KEY}
      - ROOT_DOMAIN=${ROOT_DOMAIN}
      - HASURA_PROXY_PORT=${HASURA_PROXY_PORT}
      - API_PORT=${API_PORT}
      - TLS_EMAIL=${TLS_EMAIL}

volumes:
  postgres_data:
  caddy_data:
  caddy_config: