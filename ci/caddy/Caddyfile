# Wildcard certificate - this just handles provisioning the certificate, then aborts
# This ensures we request a single certificate per-Pizza, not one per-service/per-Pizza
# Without this, it's possible to hit the Let's Encrypt limits on certificates
*.{$ROOT_DOMAIN} {
    tls {
        dns vultr {$VULTR_API_KEY}
    }
    abort
}

# Individual subdomain handlers
postgres.{$ROOT_DOMAIN} {
    reverse_proxy postgres:5432
}

hasura.{$ROOT_DOMAIN} {
    reverse_proxy hasura-proxy:{$HASURA_PROXY_PORT}
}

api.{$ROOT_DOMAIN} {
    reverse_proxy api:{$API_PORT}
}

sharedb.{$ROOT_DOMAIN} {
    reverse_proxy sharedb:8000
}

localplanning.{$ROOT_DOMAIN} {
    reverse_proxy localplanning:8043
}

storybook.{$ROOT_DOMAIN} {
    reverse_proxy storybook:8044
}

# Root domain (no subdomain)
{$ROOT_DOMAIN} {
    reverse_proxy editor:8043
}